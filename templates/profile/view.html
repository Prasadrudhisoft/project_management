{% extends "base.html" %}

{% block title %}Profile - {{ user.full_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Profile Header -->
            <div class="card shadow-lg border-0 mb-4" id="id-card">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="profile-avatar-large">
                                {% if user.avatar_url %}
                                <img src="{{ user.avatar_url }}" alt="Avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                                {% else %}
                                <span class="avatar-text">{{ user.full_name[0] if user.full_name else 'U' }}</span>
                                {% endif %}
                                <div class="online-status"></div>
                            </div>
                        </div>
                        <div class="col">
                            <h2 class="mb-1">{{ user.full_name }}</h2>
                            <p class="text-muted mb-2">
                                <i class="fas fa-user-tag me-2"></i>{{ user.role|title }}
                            </p>
                            <p class="text-muted mb-1">
                                <i class="fas fa-envelope me-2"></i>{{ user.email or (session.user_email or 'No email available') }}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-building me-2"></i>{{ user.organization_name or session.organization_name or 'Organization' }}
                            </p>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('edit_profile') }}" class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>Edit Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Details -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Personal Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Full Name</label>
                                <p class="mb-0">{{ user.full_name }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Email</label>
                                <p class="mb-0">{{ user.email }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Phone</label>
                                <p class="mb-0">{{ user.phone or 'Not provided' }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Role</label>
                                <span class="badge bg-{{ 'success' if user.role == 'admin' else 'info' if user.role == 'manager' else 'secondary' }}">
                                    {{ user.role|title }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Account Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">User ID</label>
                                <p class="mb-0">{{ user.id }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Member Since</label>
                                <p class="mb-0">{% if user.created_at %}{{ user.created_at.strftime('%B %d, %Y') }}{% elif session.user_created_at %}{{ session.user_created_at }}{% else %}Unknown{% endif %}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Last Updated</label>
                                <p class="mb-0">{{ user.updated_at.strftime('%B %d, %Y') if user.updated_at else 'Never' }}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body text-center">
                            <a href="{{ url_for('edit_profile') }}" class="btn btn-primary me-3">
                                <i class="fas fa-edit me-2"></i>Edit Profile
                            </a>
                            <button type="button" class="btn btn-success me-3" id="downloadIdBtn">
                                <i class="fas fa-download me-2"></i>Download ID Card
                            </button>
                            <div class="d-inline-block dropdown me-3">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="downloadProfileMenu" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-file-download me-2"></i>Download Profile
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="downloadProfileMenu">
                                    <li><a class="dropdown-item" href="#" id="downloadProfilePng">Save as PNG</a></li>
                                    <li><a class="dropdown-item" href="#" id="downloadProfilePdf">Save as PDF</a></li>
                                </ul>
                            </div>
                            {% if session.user_role in ['admin', 'manager'] %}
                            <a href="{{ url_for('change_password') }}" class="btn btn-warning me-3">
                                <i class="fas fa-key me-2"></i>Change Password
                            </a>
                            {% endif %}
                            <a href="{{ url_for('dashboard') if session.user_role == 'admin' else url_for('manager_dashboard') if session.user_role == 'manager' else url_for('member_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.profile-avatar-large {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: bold;
    color: white;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.online-status {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    background-color: #28a745;
    border: 3px solid white;
    border-radius: 50%;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.card-header {
    border-bottom: none;
}

.badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .profile-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 2rem;
    }
    
    .btn {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .btn:last-child {
        margin-bottom: 0;
    }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('downloadIdBtn');
    if (!btn) return;
    btn.addEventListener('click', async function() {
        const card = document.getElementById('id-card');
        if (!card) return;
        // Ensure avatar images are loaded before capture
        const images = Array.from(card.querySelectorAll('img'));
        await Promise.all(images.map(img => new Promise(resolve => {
            if (img.complete) return resolve();
            img.onload = resolve; img.onerror = resolve;
        })));
        html2canvas(card, { scale: 2, backgroundColor: null, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `id-card-{{ user.id }}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    // Download entire profile page (container) as PNG/PDF
    const container = document.querySelector('.container');
    const pngBtn = document.getElementById('downloadProfilePng');
    const pdfBtn = document.getElementById('downloadProfilePdf');

    async function captureContainer() {
        // Ensure images/fonts are ready
        const images = Array.from(container.querySelectorAll('img'));
        await Promise.all(images.map(img => new Promise(resolve => {
            if (img.complete) return resolve();
            img.onload = resolve; img.onerror = resolve;
        })));
        return html2canvas(container, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
    }

    if (pngBtn) {
        pngBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const canvas = await captureContainer();
            const link = document.createElement('a');
            link.download = `profile-{{ user.id }}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }

    if (pdfBtn) {
        pdfBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            const canvas = await captureContainer();
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pageWidth;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let position = 0;
            let heightLeft = imgHeight;

            // Add pages if content overflows
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
            heightLeft -= pageHeight;
            while (heightLeft > 0) {
                pdf.addPage();
                position = heightLeft - imgHeight;
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageHeight;
            }
            pdf.save(`profile-{{ user.id }}.pdf`);
        });
    }
});
</script>
{% endblock %}
